#!/usr/bin/env bash

mkdir -p "$BTK_DATA"
cd "$BTK_DATA"

function maybe_download() {
    # $1 - file relative path
    # $2 - URL
    if [ ! -e "$1" ]; then
        echo "** Downloading $2 ..." 1>&2
        curl -o "$1" "$2" 
    fi
}

function maybe_download_gz() {
    # $1 - file relative path (w/o .gz extension)
    # $2 - URL (complete)
    if [ ! -e "$1" ]; then
        echo "** Downloading $2 ..." 1>&2
        curl "$2" | gzip -d > $1
    fi
}

###################
# Bioconductor data
###################

mkdir -p bioconductor
maybe_download_gz bioconductor/GEOmetadb.sqlite http://gbnci.abcc.ncifcrf.gov/geo/GEOmetadb.sqlite.gz
maybe_download_gz bioconductor/SRAmetadb.sqlite http://gbnci.abcc.ncifcrf.gov/backup/SRAmetadb.sqlite.gz

###############
# Stanford data
###############

# FIXME : do

###########
# NCBI data
###########

mkdir -p ncbi/{gene,geo/{miniml,matrix/{probe,gene,taxon}},taxonomy}

gene_files="gene_info gene2go gene2accession gene2ensembl gene2refseq"
for file in $gene_files; do
    maybe_download ncbi/gene/${file}.gz \
        ftp://ftp.ncbi.nih.gov/gene/DATA/${file}.gz
done

if [ ! "$(ls -A ncbi/gene/gene-go)" ]; then
    mkdir -p ncbi/gene/gene-go/{canonical,predicted}
    cd ncbi/gene/gene-go/canonical
    {
        echo -e "Taxon ID\tGene ID\tTerm ID\tEvidence"
        zcat ../gene2go.gz \
            | sed 1d \
            | cut -f1-4
    } | dm split-by-column 1
    parallel gzip ::: *
    cd ../../../..
fi

maybe_download ncbi/taxonomy/taxdump.tar.gz \
    ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdump.tar.gz

if [ ! -e ncbi/taxonomy/id2name ]; then
    echo "* Extracting taxonomy names ..." 1&>2
    tar -O -xf ncbi/taxonomy/taxdump.tar.gz names.dmp \
        | sed 's/\t|\t/\t/g' | sed 's/\t|$//g' \
        | tawk '$4 == "scientific name" { print $1,$2 }' \
        | tawk '!($1 in a) { print; a[$1] = 0; }' \
        | sort -k1b,1 \
        > ncbi/taxonomy/id2name
fi

# MEDLINE

if [ ! -d ncbi/medline ]; then
    echo "* Downloading MEDLINE ..."
    mkdir ncbi/medline
    wget -r -nd -P ncbi/medline/ ftp://ftp.nlm.nih.gov/nlmdata/.medleasebaseline/gz/
fi

######
# UCSC
######

mkdir -p genome
genomes="hg18 hg19"
for genome in $genomes; do
    if [ ! -f genome/$genome/sizes ]; then
        mkdir -p genome/$genome
        fetchChromSizes $genome > genome/$genome/sizes
    fi
done

#####
# GEO
#####

me=ncbi/geo/miniml/GPL13534.tar.gz 
if [ -e "$me" ]; then
    mkdir -p ncbi/geo/coordinate/hg19
    bsdtar --fast-read -Oxzf "$me" GPL13534-tbl-1.txt \
        | tawk '$12 != "" {print "chr"$12,$34,$35,$1,".",$17}' \
        | sed 's/F$/+/;s/R$/-/' \
        | sort -k4b,4 \
        | gzip > ncbi/geo/coordinate/hg19/GPL13534.bed.gz
fi

############
# Ontologies
############

mkdir -p ontology
for o in bto pato go; do 
    maybe_download ontology/${o}.obo \
        http://www.berkeleybop.org/ontologies/${o}.obo
done

maybe_download ontology/ursa.tsv \
    http://ursa.princeton.edu/supp/manual_annotations_ursa.csv
