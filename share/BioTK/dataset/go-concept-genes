#!/usr/bin/env bash

annotation_type="canonical"
while getopts p opt; do
    case $opt in
        p) annotation_type="predicted" ;;
    esac
done
shift $((OPTIND - 1))

taxon_id="$1"
dir="$BTK_DATA"/ncbi/gene/go-concept/"$annotation_type"
path="$dir"/${taxon_id}.gz
mkdir -p "$dir"

export LC_COLLATE=C

if [ -f $path ]; then
    zcat $path
    exit 0
fi

{
    get() {
        if [[ "$annotation_type" == "predicted" ]]; then
            dataset gene-go -p "$taxon_id"
        else
            dataset gene-go "$taxon_id"
        fi \
            | cut -f2,3 \
            | dm sort -k2b,2 \
            | dm join -j 2 \
                <(dataset go-concepts \
                    | cut -f1,$1 \
                    | dm sort -k2b,2) - \
            | cut -f2-3 \
            | sed 1d \
            | sort -k1b,1
    }

    positive=$(mktemp)
    negative=$(mktemp)
    result=$(mktemp)
    trap 'rm -f $positive $negative $result' EXIT
    get 2 > $positive
    get 3 > $negative

    {
        echo -e "Concept\tGene ID\tDirection"
        comm -2 -3 $positive $negative | tawk '{print $1,$2,"1"}'
        comm -1 -3 $positive $negative | tawk '{print $1,$2,"-1"}'
    } | dm sort -k1b,1 > $result

    dm join -j 1 $result \
        <(
            {
                echo -e "Concept"
                dm cuniq 1 3 < $result
            }   | cut -f1 \
                | uniq -d \
                | dm sort -k1b,1) \
        | dm sort -k1,1b -k3,3b
} | tee >(gzip > $path)
